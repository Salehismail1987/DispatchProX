<div class="wrapper">
    <app-dashboard-header  [active_menu]="this.active_menu"></app-dashboard-header>
    <div id="content">
        <app-dashboard-top-header ></app-dashboard-top-header>
        <form [formGroup]="ticketForm"  enctype="multipart/form-data">
            <div class="body-content2 cp-lg-1">
                <div class="title-17 text-black mb-14">New dispatch</div>
                <div class="bg-light-yellow2 border-div cp-6 br-15 mb-37">
                    <div class="title-20 text-black mb-20">
                        {{this.selected_cc?.company_name}}
                    </div>
                    <div class="row">
                        <div class="col-lg-3 col-md-6">
                            <span *ngIf="this.projectError!= ''" class="text-danger">{{
                                this.projectError
                                }}</span>
                            <div class="input-div2 getinputfield mb-13">
                                <div class="desc-5 text-color-grey text-left">Project name</div>
                                <input type="hidden" formControlName="project_id">
                                <input type="text" class="title-16 myinput4" readonly value="{{this.selected_project?.project_name}}" placeholder="">
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <span *ngIf="this.ticketDateError!= ''" class="text-danger">{{
                                this.ticketDateError
                                }}</span>
                            <div class="input-div2 getinputfield required_field mb-13">
                                <div class="desc-5 text-color-grey text-left">When</div>
                                <input type="date" class="title-16 myinput4 input-date" formControlName="ticket_date" (change)="dateChange($event)" [min]=" this.todayDate" placeholder="dd/mm/yyyy">
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">

                            <div class="input-div2 getinputfield mb-13">
                                <div class="desc-5 text-color-grey text-left">Job approver
                                </div>
                                <select class="title-16 myinput4 input-date ml-minus-3" formControlName="approver_id" (change)="setApprover($event)">
                                    <option value="{{this.loggedinUser?.id}}" [selected]="this.selected_approver?.id == this.loggedinUser?.id">{{this.loggedinUser.full_name}}</option>
                                    <option *ngFor="let item of this.approvers_list" value="{{item.full_name? item.id : item.user.id}}" [selected]="item.is_default=='YES' ? true:false" >{{item.full_name? item.full_name : item.user.full_name}} </option>
                                </select>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6">
                            <div class="desc-1 text-black mb-13">
                                Set the name of the job approver if you know who it is. Driver can fill that later. Please, make sure “paper ticket ID needed” is selected when you need that ID included on the approved ticket.
                            </div>
                        </div>
                        <div class="col-md-12">
                            <span *ngIf="this.descriptionError!= ''" class="text-danger">{{
                                this.descriptionError
                                }}</span>
                            <div class="input-div2 getinputfield">
                                <textarea formControlName="description" id="" class="title-16 myinput4" rows="3" placeholder="Description / instructions"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="setting-content-page border-div custom-padding5 mb-21">
                    <div class="title-20 text-black">Customer</div>
                    <div class="row mb-19">
                        <div class="col-lg-3 col-md-5">
                            <div class="mb-14"></div>
                            <div class="input-div2 required_field getinputfield">
                                <div class="desc-5 text-color-grey text-left mb-5px">Customer name</div>
                                <input type="hidden" formControlName="customer_id">
                                <div class="title-16 myinput4 input-date" *ngIf="this.selected_cc">{{this.selected_cc.company_name}}</div>
                                <div class="title-16 myinput4 input-date" *ngIf="!this.selected_cc">Select</div>
                                <img src="../../assets/icons/arrow-down.png" class="icon-center-right2">
                                <div class="input-popup-div customer-div cp-9">
                                    <div class="desc-5 text-black-shade3 mb-3px">Customer</div>
                                    <div class="desc-6 text-color-grey2 text-right mb-2px">Default</div>

                                    <ng-container *ngFor="let item of cc_lists">
                                        <div class="d-flex justify-content-between  mb-9">
                                            <div [class]="this.selected_cc_id==item.id?'title-7 text-black-shade3':'title-7 text-color-grey'" (click)="setCC(item)">{{item.company_name}}</div>
                                            <input type="checkbox" class="mycheckbox2"
                                            (change)="setDefault($event,'default_cc_id',item.id)"
                                            [checked]="this.tc_dispatch_setting?.default_cc_id == item.id ? true:false">
                                        </div>
                                    </ng-container>

                                    <div class="position-relative" data-toggle="modal" data-target="#addCustomer">
                                        <div class="myinput-new myinput3 text-color-black-shade8">Add</div>
                                        <img src="../../assets/icons/edit.png" class="icon-bottom-right2">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-7">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="title-7 ">#</div>
                                    <span *ngIf="ticketForm.get('number_of_trucks')?.invalid && (form_clicked)"
                                    class="text-danger">
                                        Number of trucks is invalid or missing.
                                    </span>
                                    <div class="input-div2 getinputfield mb-13 d-flex justify-content-between align-items-center required_field">
                                        <div class="desc-5 text-color-grey text-left">Number of trucks</div>
                                        <div>
                                            <input type="text" formControlName="number_of_trucks" (change)="changeNumber($event)"  class="input-div3 ml-2 title-16 text-black" placeholder="5">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="title-7 ">Rate</div>
                                    <span *ngIf="ticketForm.get('rate_per_hour_to_tc')?.invalid && (form_clicked)"
                                    class="text-danger">
                                        Hour rate to you is invalid or missing.
                                    </span>
                                    <div class="input-div2 getinputfield mb-13 d-flex justify-content-between align-items-center required_field">
                                        <div class="desc-5 text-color-grey text-left">Hour rate to you</div>
                                        <div>
                                            <input type="text" (change)="setRate($event)" formControlName="rate_per_hour_to_tc" class="input-div3 ml-2 title-16 text-black" placeholder="$220">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-5 col-md-12">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="title-7 ">Time</div>
                                    <span *ngIf="ticketForm.get('first_truck_start_at')?.invalid && (form_clicked)"
                                    class="text-danger">
                                        Time is invalid or missing.
                                    </span>
                                    <div class="input-div2 getinputfield mb-13 d-flex justify-content-between align-items-center required_field">
                                        <div class="desc-5 text-color-grey text-left">First truck to start at</div>
                                        <div>
                                            <input type="time" formControlName="first_truck_start_at" style="width:max-content" class="input-div3 ml-1 title-16 text-black" placeholder="00 min">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">

                                    <div class="mb-14"></div>
                                    <span *ngIf="ticketForm.get('interval_between_truck')?.invalid && (form_clicked)"
                                    class="text-danger">
                                        Interval is invalid or missing.
                                    </span>
                                    <div class="input-div2 getinputfield mb-13 d-flex justify-content-between align-items-center">
                                        <div class="desc-5 text-color-grey text-left">Interval between trucks</div>

                                        <div>
                                            <input type="text" formControlName="interval_between_truck" class="input-div3 ml-2 title-16 text-black" placeholder="00 min">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-19">
                        <div class="col-lg-3 col-md-5">
                            <div class="desc-1 text-black mb-10">Set here rates you are getting paid, number of trucks asked. Set the start time for the first truck and intervals between the trucks. Set type of trucks and trailers and last, set rounds. Note that the driver can modify rounds
                                while driving. </div>
                        </div>
                        <div class="col-lg-4 col-md-7">
                            <div class="title-7 ">Truck & trailer type</div>
                            <div class="row">
                                <div class="col-md-6">
                                    <span *ngIf="ticketForm.get('ticket_truck_type')?.invalid && (form_clicked)"
                                    class="text-danger">
                                        Truck type is missing.
                                    </span>

                                    <input type="hidden" formControlName="ticket_truck_type">
                                    <div class="input-div2 getinputfield mb-13">
                                        <div class="desc-5 text-color-grey text-left mb-5px">Select truck</div>
                                        <div class="title-16 myinput4 input-date" *ngIf="this.selected_truck_type">{{this.selected_truck_type?.name}}</div>
                                        <div class="title-16 myinput4 input-date" *ngIf="!this.selected_truck_type">Select </div>
                                        <img src="../../assets/icons/arrow-down.png" class="icon-center-right2">
                                        <div class="input-popup-div cp-9 truck-type-div ">
                                            <div class="desc-5 text-black-shade3 mb-3px">Select truck
                                            </div>
                                            <div class="desc-6 text-color-grey2 text-right mb-2px">Default</div>
                                            <ng-container  *ngFor="let item of this.truck_types">
                                                <div class="d-flex justify-content-between  mb-9">
                                                    <div  [class]="this.selected_truck_type?.name==item.name?'title-7 text-black-shade3':'title-7 text-color-grey'" (click)="setTruckType(item)">{{item.name}}</div>

                                                    <input type="checkbox" class="mycheckbox2"
                                                    (change)="setDefault($event,'default_truck_type',item.name)"
                                                    [checked]="this.tc_dispatch_setting?.default_truck_type?.name == item.name ? true:false">
                                                </div>
                                            </ng-container>

                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <input type="hidden" formControlName="ticket_trailer_type">
                                    <div class="input-div2 getinputfield mb-13">
                                        <div class="desc-5 text-color-grey text-left mb-5px">Select trailer</div>
                                        <div class="title-16 myinput4 input-date" *ngIf="this.selected_trailer_type">{{this.selected_trailer_type?.name}}</div>
                                        <div class="title-16 myinput4 input-date" *ngIf="!this.selected_trailer_type">
                                            {{this.selected_trailer_type=='' && !this.selected_trailer_type? 'Select':'None'}} </div>
                                        <img src="../../assets/icons/arrow-down.png" class="icon-center-right2">
                                        <div class="input-popup-div trailer-type-div cp-9">
                                            <div class="desc-5 text-black-shade3 mb-3px">Select trailer

                                            </div>

                                            <div class="desc-6 text-color-grey2 text-right mb-2px">Default</div>

                                            <ng-container  *ngFor="let item of this.trailer_types">

                                                <div class="d-flex justify-content-between  mb-9">
                                                    <div  [class]="this.selected_trailer_type?.name==item.name?'title-7 text-black-shade3':'title-7 text-color-grey'" (click)="setTrailerType(item)">{{item.name}}</div>

                                                    <input type="checkbox"
                                                    (change)="setDefault($event,'default_trailer_type',item.name)"
                                                    [checked]="this.tc_dispatch_setting?.default_trailer_type == item.name ? true:false" class="mycheckbox2">
                                                </div>
                                            </ng-container>
                                            <div class="d-flex justify-content-between  mb-9">
                                                <div   [class]="!this.selected_trailer_type? 'title-7 text-black-shade3':'title-7 text-color-grey'" (click)="setTrailerType('')">None</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-5 col-md-12">

                            <div class="title-7 ">Rounds</div>

                            <table class="rounds-table">
                                <thead>
                                    <tr>
                                        <th></th>
                                        <th>Material out</th>
                                        <th>Dump site</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <ng-container formArrayName="rounds" *ngFor="let fields of rounds().controls; let roundIdx = index;">
                                        <ng-container [formGroupName]="roundIdx">
                                            <tr>
                                                <td>
                                                    <div class="title-5-new text-black">{{roundIdx+1}}</div>
                                                </td>
                                                <td>
                                                    <span *ngIf="fields.get('material_taken_out')?.invalid && (form_clicked)"
                                                    class="text-danger">
                                                    Material taken out is required.
                                                    </span>
                                                    <input type="text" formControlName="material_taken_out" placeholder="Type here" class="form-control br-5"></td>
                                                <td>
                                                    <span *ngIf="fields.get('dump_site')?.invalid && (form_clicked)"
                                                    class="text-danger">
                                                    Dump site is required.
                                                    </span>
                                                    <select class="form-control br-5" formControlName="dump_site">
                                                        <option value="">Select</option>
                                                        <option *ngFor="let item of this.dump_sites" value="{{item.dump_site}}">{{item.dump_site}}</option>

                                                    </select>
                                                </td>
                                            </tr>
                                        </ng-container>
                                    </ng-container>
                                    <tr>
                                        <td>
                                            <div class="title-5-new text-color-grey ">{{rounds().length + 1}}</div>
                                        </td>
                                        <td></td>
                                        <td>
                                            <div align="right">
                                                <button type="button" class="btn-grey" (click)="copyRound((rounds().length >0 ? rounds().length-1 : 0))">Copy round</button>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="setting-content-page border-div custom-padding5 mb-105">
                    <div class="title-20 text-black">Vendor</div>
                    <ng-container formArrayName="dispatches">
                        <ng-container *ngFor="let fields of dispatches().controls; let roundIdx = index;">
                            <ng-container [formGroupName]="roundIdx">
                                <div class="row mb-19">
                                    <div class="col-lg-4 col-md-5">
                                        <div class="mb-14">
                                            <span *ngIf="this.dispatchDriverForm.invalid && fields.get('trucking_company_id')?.value==this.loggedinUser?.id" class="text-danger">
                                                Drivers are required for self assign tickets
                                            </span>
                                        </div>
                                        <span *ngIf="fields.get('trucking_company_id')?.invalid && (form_clicked)"
                                        class="text-danger">
                                        Vendor is required.
                                        </span>
                                        <input type="hidden" formControlName="trucking_company_id">
                                        <div class="input-div2 getinputfield mb-13 required_field">
                                            <div class="desc-5 text-color-grey text-left mb-5px">Vendor name</div>

                                            <div class="title-16 myinput4 input-date" *ngIf="fields.get('trucking_company_id')?.value">{{getVendorName(fields.get('trucking_company_id')?.value)}}</div>
                                            <div class="title-16 myinput4 input-date" *ngIf="!fields.get('trucking_company_id')?.value">Select</div>
                                            <img src="../../assets/icons/arrow-down.png" class="icon-center-right2">

                                            <div class="input-popup-div vendor-div cp-9">
                                                <div class="desc-5 text-black-shade3 mb-3px">Vendor</div>
                                                <div class="desc-6 text-color-grey2 text-right mb-2px">Default</div>

                                                <div class="position-relative getinputfield2   mb-9">
                                                    <div class="d-flex justify-content-between">
                                                        <div [class]="fields.get('trucking_company_id')?.value == this.loggedinUser.id? 'title-7 text-black':' title-7 text-color-grey'"  (click)="setVendor(this.loggedinUser,roundIdx)">{{this.loggedinUser?.company_name}}</div>
                                                        <input type="checkbox" class="mycheckbox2"
                                                        (change)="setDefault($event,'default_vendor_id',this.loggedinUser.id,roundIdx)"
                                                        [checked]="this.tc_dispatch_setting?.default_vendor_id == this.loggedinUser?.id ? true:false">
                                                    </div>
                                                </div>
                                                <!-- <div class="input-popup-div2 custom-padding-10 vendor-div-width">
                                                    <div class="title-20 mb-10">Vendor</div>
                                                    <ng-container >
                                                        <ng-container  *ngFor="let fields of ticketForm.get('dispatches')?.value let idx = index;">
                                                            <ng-container >
                                                                <div class="row mb-44">
                                                                    <div class="col-lg-6">
                                                                        <span *ngIf="this.dispatches().at(idx).get('trucking_company_id')?.invalid && (form_clicked)"   class="text-danger">
                                                                           Vendor is required.
                                                                            </span>
                                                                        <div class="input-div2 mb-13 required_field">
                                                                            <div class="desc-5 text-color-grey text-left mb-5px">Vendor name</div>

                                                                            <div class="title-16 myinput4 input-date" *ngIf="fields.trucking_company_id">{{getVendorName(fields.trucking_company_id)}}</div>
                                                                            <div class="title-16 myinput4 input-date" *ngIf="!fields.trucking_company_id">Select</div>
                                                                            <img src="../../assets/icons/arrow-down.png" class="icon-center-right2">
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-lg-3">
                                                                        <span *ngIf="this.dispatches().at(idx).get('number_of_trucks')?.invalid && (form_clicked)"   class="text-danger">
                                                                            Number of trucks is invalid or missing.
                                                                            </span>
                                                                        <div class="input-div2 getinputfield mb-13 d-flex justify-content-between align-items-center required_field" >
                                                                            <div class="desc-5 text-color-grey text-left">Number of trucks</div>
                                                                            <div>
                                                                                <input type="text"
                                                                                formControlName="number_of_trucks"
                                                                                (change)="setTruckNo($event,idx)"
                                                                                value="{{fields.number_of_trucks}}"  class="input-div3 ml-2 title-16 text-black width-33" placeholder="3">
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-lg-3">
                                                                        <span *ngIf="this.dispatches().at(idx).get('rate_per_hour')?.invalid && (form_clicked)"   class="text-danger">
                                                                        Hour rate is invalid or missing.
                                                                        </span>
                                                                        <div class="input-div2 getinputfield mb-13 d-flex justify-content-between align-items-center required_field">
                                                                            <div class="desc-5 text-color-grey text-left">Hour rate you pay</div>
                                                                            <div>
                                                                                <input type="text" formControlName="rate_per_hour" value="{{fields.rate_per_hour}}" class="input-div3 ml-2 title-16 text-black" placeholder="">
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </ng-container>
                                                        </ng-container>
                                                    </ng-container>


                                                </div> -->
                                                <ng-container *ngFor="let item of this.vendors_list">
                                                    <div class="d-flex justify-content-between  mb-9">
                                                        <div [class]="fields.get('trucking_company_id')?.value == item.id? 'title-7 text-black':' title-7 text-color-grey'" (click)="setVendor(item,roundIdx)">{{item.company_name}}</div>
                                                        <input type="checkbox" class="mycheckbox2"
                                                        (change)="setDefault($event,'default_vendor_id',item.id,roundIdx)"
                                                        [checked]="this.tc_dispatch_setting?.default_vendor_id  == item.id ? true:false">
                                                    </div>
                                                </ng-container>

                                                <div class="position-relative getinputfield4">
                                                    <div class="myinput-new myinput3 text-color-black-shade8">Add</div>
                                                    <img src="../../assets/icons/edit.png" class="icon-bottom-right2">
                                                </div>

                                                <!-- invitation popup -->
                                                <div class="input-popup-div4">
                                                    <div class="title-3 text-center mb-19">Add vendor</div>
                                                    <form  [formGroup]="inviteTCForm" (ngSubmit)="onInviteTC()">
                                                        <div class="d-flex align-items-center">

                                                            <div class="desc-5 text-black-shade3 mb-7">Name</div>
                                                            <div class="required_field_label ml-5px">*</div>
                                                        </div>
                                                        <div *ngIf="inviteTCfull_nameError != ''" class="text-danger">{{
                                                            inviteTCfull_nameError
                                                        }}</div>

                                                        <div class="position-relative mb-15">
                                                            <input type="text" formControlName="full_name" class="myinput-new myinput3" placeholder="Type here">
                                                            <img src="../../assets/icons/edit.png" class="icon-bottom-right2">
                                                        </div>

                                                        <!-- <div class="desc-5 text-black-shade3 mb-7">Contact number</div>
                                                        <div class="position-relative mb-15">
                                                            <input type="text" class="myinput-new myinput3" formControlName="contact_number" (input)="changeNumber3($event)" placeholder="(---) --- ----">
                                                            <img src="../../assets/icons/edit.png" class="icon-bottom-right2">
                                                        </div> -->

                                                        <div class="d-flex align-items-center">

                                                            <div class="desc-5 text-black-shade3 mb-7">Email address</div>
                                                            <div class="required_field_label ml-5px">*</div>
                                                        </div>
                                                        <div *ngIf="inviteTCEmailError != ''" class="text-danger">{{
                                                            inviteTCEmailError
                                                        }}</div>

                                                        <div class="position-relative mb-15">
                                                            <input type="text" class="myinput-new myinput3" formControlName="email" placeholder="Type here">
                                                            <img src="../../assets/icons/edit.png" class="icon-bottom-right2">
                                                        </div>
                                                        <div align="center" class="mb-17">
                                                            <button class="mybtn2 bg-medium-blue cp-4 text-white" *ngIf="!is_loading_inv " type="submit" >Add</button>
                                                            <button class="mybtn2 bg-medium-blue cp-4 text-white" *ngIf="is_loading_inv " disabled>Processing...</button>

                                                        </div>
                                                    </form>
                                                </div>

                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-5 col-md-7">
                                        <div class="row">

                                            <div class="col-md-6">
                                                <span *ngIf="fields.get('number_of_trucks')?.invalid && (form_clicked)"
                                                class="text-danger">
                                                Number of trucks is invalid or missing.
                                                </span>
                                                <div class="title-7 ">#</div>
                                                <div class="input-div2 getinputfield mb-13 d-flex justify-content-between align-items-center required_field">
                                                    <div class="desc-5 text-color-grey text-left">Number of trucks</div>
                                                    <div>
                                                        <input type="text"  formControlName="number_of_trucks"
                                                        value="{{fields.get('number_of_trucks')?.value}}"
                                                        (change)="setTruckNo($event,roundIdx)"
                                                        class="input-div3 ml-2 title-16 text-black" placeholder="...">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <span *ngIf="fields.get('rate_per_hour')?.invalid && (form_clicked)"
                                                class="text-danger">
                                                    Hour rate is invalid or missing.
                                                </span>
                                                <span *ngIf="parseInt(fields.get('rate_per_hour')?.value) > parseInt(ticketForm.get('rate_per_hour_to_tc')?.value) && (form_clicked)"
                                                class="text-danger">
                                                    Hour rate cannot be more than Customer given rate {{ticketForm.get('rate_per_hour_to_tc')?.value}}.
                                                </span>
                                                <div class="title-7 ">Rate</div>
                                                <div class="input-div2 getinputfield mb-13 d-flex justify-content-between align-items-center required_field">
                                                    <div class="desc-5 text-color-grey text-left">Hour rate you pay</div>
                                                    <div>
                                                        <input type="text"
                                                        [readOnly]="fields.get('trucking_company_id')?.value==this.loggedinUser?.id"
                                                        formControlName="rate_per_hour" class="{{fields.get('trucking_company_id')?.value==this.loggedinUser?.id ? 'bg-grey ':''}} input-div3 ml-2 title-16 text-black" placeholder="$">
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </ng-container>
                        </ng-container>
                    </ng-container>
                </div>
                <div class="setting-content-page border-div custom-padding5">
                    <div class="title-20 text-black mb-15">Dispatch</div>
                    <div class="row">
                        <div class="col-lg-2">
                        </div>
                        <div class="col-lg-9 col-md-12">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="d-flex align-items-center mb-7">
                                        <div class="title-20 text-black-shade">Require paper tickets</div>
                                        <input type="checkbox" formControlName="required_paper_ticket_id" id="" class="checkbox-size2 ml-23">
                                    </div>
                                    <div class="title-21 text-grey-shade mb-14">If selected, drivers are required to fill the paper ticket</div>
                                </div>

                                <div class="col-md-6">
                                    <div class="repeat-dispatch mb-14">
                                        <div class="title-20 text-black-shade">Repeat this dispatch?</div>
                                        <div class="field text-field w-100">
                                            <input class="field__input" placeholder="" name="scheduled_date" type="text" name="daterange" autocomplete="off"
                                            bsDaterangepicker  [bsConfig]="{minDate:this.minDateDispatch, rangeInputFormat : 'MMMM Do YYYY', dateInputFormat: 'MMMM Do YYYY', showWeekNumbers: false }"  (bsValueChange)="dateRangeCreated($event)"  >
                                            <span class="field__label-wrap">
                                            <span class="field__label">Schedule the dispatch</span>
                                            </span>
                                        </div>

                                    </div>
                                </div>
                                <input type="hidden" formControlName="range_start" [(ngModel)]="this.schedule_date_from">
                                <input type="hidden" formControlName="range_end" [(ngModel)]="this.schedule_date_to">
                                <div class="col-md-12">
                                    <div align="center" class="d-flex justify-content-center">
                                        <button type="button" class="mybtn-default cp-8" [routerLink]="'/tc-project-lists'">Back</button>
                                        <button type="button" (click)="onSaveTicket()" *ngIf="is_loading_add=='' || is_loading_add !='tc_ticket'" class="mybtn2 bg-medium-blue cp-8 text-white br-5  ml-23" >Dispatch {{this.to_dispatch_total && to_dispatch_total!==null && to_dispatch_total !==undefined ? "["+to_dispatch_total+"]":''}}</button>
                                        <button disabled class="mybtn2 bg-medium-blue cp-8 text-white br-5  ml-23" type="button" *ngIf="is_loading_add!='' && is_loading_add =='tc_ticket'">Processing..</button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="modal fade come-from-modal right show " id="addCustomer" tabindex="-1 " role="dialog " aria-labelledby="myModalLabel ">
    <div class="modal-dialog" role="document ">
        <div class="modal-content">
            <div class="modal-body ">
                <div class="d-flex justify-content-between mb-18">
                    <div class="title-5-new mb-13">Add customer</div>
                </div>
                <form [formGroup]="addCompany">
                    <div class="row ">
                        <div class="col-md-6">
                            <div class=" mb-25">
                                <div class="d-flex ">
                                    <div class="desc-5 text-grey-shade2  mb-6">Company name</div>
                                </div>
                                <span *ngIf="addCompany.get('company_name')?.invalid && (form_clicked)"
                                class="text-danger">
                                    Company name is required.
                                </span>
                                <div class="position-relative">
                                    <input type="text" class="myinput5" placeholder="Type here" formControlName="company_name" value="">
                                    <img src="../../assets/icons/pencile.svg" alt="" class="input-icon-right3" width="17px">
                                    <div class="required ml-1">*</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                        </div>
                    </div>
                    <div class="border-div2 mb-6">
                        <div class="custom-padding15">
                            <div class="title-5-new">Address</div>
                        </div>
                        <div class="myhr2"></div>
                        <div class="custom-padding15">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class=" mb-6">
                                        <div class="d-flex ">
                                            <div class="desc-5 text-grey-shade2  mb-6">Street</div>
                                        </div>
                                        <div class="position-relative">
                                            <input type="text" class="myinput5" formControlName="address" placeholder="..." value="">
                                            <img src="../../assets/icons/pencile.svg" alt="" class="input-icon-right3" width="17px">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class=" mb-6">
                                        <div class="d-flex ">
                                            <div class="desc-5 text-grey-shade2  mb-6">City</div>
                                        </div>
                                        <div class="position-relative">
                                            <input type="text" class="myinput5" formControlName="city" placeholder="..." value="">
                                            <img src="../../assets/icons/pencile.svg" alt="" class="input-icon-right3" width="17px">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="myhr2"></div>
                        <div class="custom-padding15">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class=" mb-6">
                                        <div class="d-flex ">
                                            <div class="desc-5 text-grey-shade2  mb-6">Province/ State</div>
                                        </div>
                                        <div class="position-relative">
                                            <select formControlName="province" class="select_state myinput-new myinput3" >
                                                <option value="">Select</option>
                                                <option value="Alberta">Alberta </option>
                                                <option value="British Columbia">British Columbia</option>
                                                <option value="Manitoba">Manitoba </option>
                                                <option value="New Brunswick">New Brunswick </option>
                                                <option value="NewFoundland and Labrador">NewFoundland and Labrador </option>
                                                <option value="Northwest Territories">Northwest Territories </option>
                                                <option value="Nova Scotia">Nova Scotia </option>
                                                <option value="Nunavut">Nunavut </option>
                                                <option value="Ontario">Ontario </option>
                                                <option value="Prince Edward Island">Prince Edward Island </option>
                                                <option value="Quebec">Quebec </option>
                                                <option value="Saskatchewan">Saskatchewan </option>
                                                <option value="Yukon">Yukon </option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class=" mb-6">
                                        <div class="d-flex ">
                                            <div class="desc-5 text-grey-shade2  mb-6">Postal code</div>
                                        </div>
                                        <div class="position-relative">
                                            <input type="text" class="myinput5" placeholder="..." formControlName="post_code" value="">
                                            <img src="../../assets/icons/pencile.svg" alt="" class="input-icon-right3" width="17px">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="border-div2 mb-23">
                        <div class="custom-padding15">
                            <div class="title-5-new">Contact people</div>
                        </div>
                        <div class="myhr2"></div>
                        <div class="custom-padding15">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class=" mb-6">
                                        <div class="d-flex ">
                                            <div class="desc-5 text-grey-shade2  mb-6">Primary contact name</div>
                                        </div>
                                        <span *ngIf="addCompany.get('full_name')?.invalid && (form_clicked)"
                                        class="text-danger">
                                           Contact name is required.
                                        </span>
                                        <div class="position-relative">
                                            <input type="text" class="myinput5" placeholder="..." formControlName="full_name" value="">
                                            <img src="../../assets/icons/pencile.svg" alt="" class="input-icon-right3" width="17px">
                                            <div class="required ml-1">*</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class=" mb-6">
                                        <div class="d-flex ">
                                            <div class="desc-5 text-grey-shade2  mb-6">Email</div>
                                        </div>
                                        <div class="position-relative">
                                            <input type="text" class="myinput5" placeholder="type@here" formControlName="email" value="">
                                            <img src="../../assets/icons/pencile.svg" alt="" class="input-icon-right3" width="17px">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="myhr2"></div>
                        <div class="custom-padding15">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class=" mb-6">
                                        <div class="d-flex ">
                                            <div class="desc-5 text-grey-shade2  mb-6">Phone number</div>
                                        </div>
                                        <div class="position-relative">
                                            <input type="text" class="myinput5" (input)="changeNumber2($event)" placeholder="(---) --- ----" formControlName="contact_number" value="">
                                            <img src="../../assets/icons/pencile.svg" alt="" class="input-icon-right3" width="17px">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row ">
                        <div class="col-md-4">
                        </div>
                        <div class="col-md-4">
                            <button class="mybtn2 title-13 mybtn-back-blue2 text-white p-8 m-0" (click)="handleAddCompany()" *ngIf="is_loading_add =='' || is_loading_add !='add_company'">Add</button>
                            <button class="mybtn2 title-13 mybtn-back-blue2 text-white p-8 m-0" *ngIf="is_loading_add !='' && is_loading_add =='add_company'" disabled>Processing..</button>
                        </div>
                    </div>
                </form>

            </div>
        </div>
    </div>
</div>
<div class="modal fade come-from-modal right show " id="assignDrivers" tabindex="-1 " role="dialog " aria-labelledby="myModalLabel ">
    <div class="modal-dialog" role="document ">
        <div class="modal-content">
            <div class="modal-body ">
                <div>
                    <a class="float-right" (click)="closeAssignDriver(); checkDriversError()" style="position:absolute;top:10px;right:10px"><img style="cursor:pointer" data-dismiss="modal" src="assets/icons/cross-box.svg"/></a>
                </div>
                <div class="d-flex justify-content-between mb-18">
                    <div class="title-5-new mb-13">Assign drivers</div>
                </div>

                <span class="text-danger" *ngIf="this.driver_message !=''">{{this.driver_message}}</span>
                <form [formGroup]="this.dispatchDriverForm"  enctype="multipart/form-data">
                    <input type="hidden" formControlName="trucking_company_id" [(ngModel)]="this.user_id" />
                    <input type="hidden" formControlName="user_id" [(ngModel)]="this.user_id" />

                    <ng-container formArrayName="driver_tickets">
                        <ng-container *ngFor="let formItem of driver_tickets.controls; let idx = index">
                            <ng-container [formGroupName]="idx">
                                <!-- <div class="div-2 mb-12">
                                    <div class="assign-drivers-div mb-6">
                                        <div class="width-32-p">
                                            <div class="div-3">
                                                <div class="desc-5 text-white mb-5px">Ticket ID</div>
                                                <div class="title-5-new text-white">WA-0008511</div>
                                            </div>
                                        </div>
                                        <div class="width-32-p">
                                            <div class="input-div2 getinputfield">
                                                <div class="desc-5 text-color-grey text-left">Job approver</div>
                                                <select class="title-16 myinput4 input-date ml-minus-3">
                                                <option value="">Ricky Road</option>
                                            </select>
                                            </div>
                                        </div>
                                        <div class="width-32-p">
                                            <div class="input-div2 getinputfield">
                                                <div class="desc-5 text-color-grey text-left">$/hr rate for driver</div>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <input type="text" class="input-div3 title-16 text-black" placeholder="$220">
                                                    <div class="title-7 text-color-grey">32%</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="assign-drivers-div">
                                        <div class="width-49-p">
                                            <div class="input-div2 getinputfield">
                                                <div class="desc-5 text-color-grey text-left">Job approver</div>
                                                <select class="title-16 myinput4 input-date ml-minus-3">
                                                <option value="">Ricky Road</option>
                                            </select>
                                            </div>
                                        </div>
                                        <div class="width-49-p">
                                            <div class="input-div2 getinputfield">
                                                <div class="desc-5 text-color-grey text-left">Job approver</div>
                                                <select class="title-16 myinput4 input-date ml-minus-3">
                                                <option value="">Ricky Road</option>
                                            </select>
                                            </div>
                                        </div>
                                    </div>
                                </div> -->
                                <div class="row border-blue-div pt-2 p-1 mb-3">
                                    <div class="col-md-4 pl-3px pr-3px">

                                        <label [class]="formItem.get('rates')?.value !='' && formItem.get('driver_id')?.value !='' && formItem.get('truck_id')?.value !='' && formItem.get('trailer_id')?.value !=''  ?  'driver-selected field text-field':' field text-field bg-light-grey'">
                                            <div class=""
                                            [class]="formItem.get('rates')?.value !='' && formItem.get('driver_id')?.value !='' && formItem.get('truck_id')?.value !='' && formItem.get('trailer_id')?.value !=''  ?  'driver-selected field__input bg-light-grey pt-27px':' field__input bg-light-grey pt-27px'"
                                            >{{formItem.get('ticket_no')?.value}}</div>
                                            <span class="field__label-wrap">
                                            <span class=""
                                            [class]="formItem.get('rates')?.value !='' && formItem.get('driver_id')?.value !='' && formItem.get('truck_id')?.value !='' && formItem.get('trailer_id')?.value !=''  ?  'driver-selected field__label ':' field__label bg-light-grey'"
                                            >Ticket ID</span>
                                            </span>
                                        </label>
                                    </div>
                                    <div class="col-md-4 pl-3px pr-3px">
                                        <span class="text-danger" *ngIf="form_clicked_driver && this.is_driver_form_error && formItem.get('driver_id')?.value == ''">Driver is required</span>
                                        <div class="input-div2  getinputfield">
                                            <div class="desc-5 text-color-grey text-left mb-5px">Driver</div>
                                            <input type="hidden" formControlName="driver_id">
                                            <div class="title-16 myinput4 input-date" *ngIf="formItem.get('driver')?.value">{{formItem.get('driver')?.value?.full_name}}</div>
                                            <div class="title-16 myinput4 input-date" *ngIf="!formItem.get('driver')?.value">Select</div>
                                            <img src="../../assets/icons/arrow-down.png" class="icon-center-right2">
                                            <div class="input-popup-div driver-div cp-9">
                                                <div class="desc-5 text-black-shade3 mb-3px p-7p-label">Select Driver</div>

                                                <ng-container *ngFor="let driver of this.drivers_list">

                                                    <div class="d-flex justify-content-between  mb-1" *ngIf="getDriverAvailable(formItem.get('ticket_no')?.value, driver) && (checkAvailable('driver',driver,idx) || formItem.get('driver_id')?.value==driver.id); else elseDriver">

                                                        <div [class]="formItem.get('driver_id')?.value==driver.id?'title-7 p-7p  text-black-shade3':'title-7 p-7p text-color-grey'" (click)="setDriver(idx,driver,formItem.get('ticket_id')?.value)">{{driver.full_name}}</div>

                                                    </div>

                                                    <ng-template #elseDriver>
                                                        <div class="d-flex justify-content-between  " >
                                                            <div class='p-7p-disabled text-color-grey' >{{driver.full_name}}-
                                                                <ng-container *ngFor="let ava of this.driver_availability">
                                                                    <ng-container *ngIf="ava.driver_id == driver?.id && ava.ticket_id==formItem.get('ticket_no')?.value && ava.is_available==false">
                                                                        {{ava?.current_job? ava?.current_job?.ticket?.ticket_no:''}}

                                                                    </ng-container>
                                                                </ng-container>
                                                            </div>

                                                        </div>
                                                    </ng-template>
                                                </ng-container>
                                            </div>
                                        </div>

                                    </div>
                                    <div class="col-md-4 pr-3px  pl-3px border-rate mb-1">

                                        <span class="text-danger" *ngIf="form_clicked_driver && ( formItem.get('rates')?.value == '' || formItem.get('rates')?.value == null)">Rate is required</span>
                                        <span class="text-danger" *ngIf="form_clicked_driver && ( formItem.get('rates')?.invalid && formItem.get('rates')?.hasError('pattern'))">Rate is invalid</span>
                                        <span class="text-danger" *ngIf="form_clicked_driver && formItem.get('rates')?.value != '' && formItem.get('rates')?.value != null && formItem.get('rates')?.errors && formItem.get('rates')?.hasError('max')">Driver rate cannot be more than {{formItem.get('ticket_rate')?.value ? formItem.get('ticket_rate')?.value:' ticket rate'}}</span>
                                        <label class="field text-field">
                                            <span class="field__label-wrap">
                                            <span class="field__label">$/hr rate driver</span>
                                            </span>
                                        </label>

                                        <input [class]="formItem.get('driver')?.value && (formItem.get('driver')?.value?.role_id==6 || formItem.get('driver')?.value?.role_id=='6')? 'bg-light-grey':''"  style="    font-family: 'Gilroy-SemiBold'; font-size: 13px; line-height: 15px; color: #272525;border: 1px solid #E1E1E1;padding:1px;border-radius: 5px;width:max-content;max-width:66px;height: 25px;margin-top: 5px;margin-left: 5px;" placeholder="$50" formControlName="rates" (input)="changeRate($event,idx)" [readonly]="formItem.get('driver')?.value && (formItem.get('driver')?.value?.role_id==6 || formItem.get('driver')?.value?.role_id=='6')? true:false" type="text">

                                        <span *ngIf="formItem.get('driver')?.value?.role_id!=6 && formItem.get('driver')?.value?.role_id!='6'" align="right" style="float: right; margin-right: 10px;margin-top:5px;">
                                            {{formItem.get('perc')?.value}}%
                                        </span>
                                    </div>
                                    <div class="col-md-6 pl-3px pr-3px">
                                        <span class="text-danger" *ngIf="form_clicked_driver && this.is_driver_form_error &&  formItem.get('truck_id')?.value == ''">Truck is required</span>

                                        <div class="input-div2  getinputfield">
                                            <div class="desc-5 text-color-grey text-left mb-5px">Truck</div>
                                            <input type="hidden" formControlName="truck_id">
                                            <div class="title-16 myinput4 input-date" *ngIf="formItem.get('truck')?.value">{{formItem.get('truck')?.value?.truck_nickname}}</div>
                                            <div class="title-16 myinput4 input-date" *ngIf="!formItem.get('truck_id')?.value">Select</div>
                                            <img src="../../assets/icons/arrow-down.png" class="icon-center-right2">
                                            <div class="input-popup-div truck-div cp-9">
                                                <div class="desc-5 text-black-shade3 mb-3px p-7p-label">Select {{
                                                    this.ticketForm.get('ticket_truck_type')?.value? this.ticketForm.get('ticket_truck_type')?.value :'Truck'
                                                    }}</div>

                                                <ng-container *ngFor="let truck of this.trucks_list">
                                                    <ng-container *ngIf="truck?.truck_type==this.ticketForm.get('ticket_truck_type')?.value ">
                                                        <!--  -->
                                                        <div class="d-flex justify-content-between " *ngIf="truck.is_available=='YES' && (checkAvailable('truck',truck,idx) || formItem.get('truck_id')?.value==truck.id)">
                                                            <div [class]="formItem.get('truck_id')?.value==truck.id?'title-7 p-7p  text-black-shade3':'title-7 p-7p text-color-grey'" (click)="setTruck(idx,truck,formItem.get('ticket_id')?.value)">{{truck.truck_nickname}}</div>

                                                        </div>
                                                    </ng-container>

                                                </ng-container>
                                                <ng-container *ngFor="let truck of this.trucks_list">
                                                    <ng-container *ngIf="truck?.truck_type==this.ticketForm.get('ticket_truck_type')?.value">
                                                        <div class="d-flex justify-content-between  " *ngIf="truck.is_available=='NO'">
                                                            <div class='p-7p-disabled text-color-grey' >{{truck.full_name}}-{{truck?.current_job? truck?.current_job?.ticket?.ticket_no:''}}</div>

                                                        </div>
                                                    </ng-container>
                                                </ng-container>
                                            </div>
                                        </div>
                                        <!-- <label class="field text-field">
                                            <select class="field__input" formControlName="truck_id" >
                                                <option value="">Select</option>
                                                <option *ngFor="let truck of this.trucks_list" [value]="truck.id" >
                                                    {{truck.truck_nickname}}
                                                </option>
                                            </select>
                                            <i class="fa fa-caret-down input-icon-right" aria-hidden="true"></i>
                                            <span class="field__label-wrap">
                                                <span class="field__label">Select truck</span>
                                            </span>
                                        </label> -->
                                    </div>

                                    <div class="col-md-6 pr-3px pl-3px">

                                        <ng-container *ngIf="this.selected_trailer_type">
                                            <div class="input-div2  getinputfield">
                                                <div class="desc-5 text-color-grey text-left mb-5px">Trailer</div>
                                                <input type="hidden" formControlName="trailer_id">
                                                <div class="title-16 myinput4 input-date" *ngIf="formItem.get('trailer')?.value">{{formItem.get('trailer')?.value?.trailer_nickname}}</div>
                                                <div class="title-16 myinput4 input-date" *ngIf="!formItem.get('trailer_id')?.value">Select</div>
                                                <img src="../../assets/icons/arrow-down.png" class="icon-center-right2">
                                                <div class="input-popup-div trailer-div cp-9">
                                                    <div class="desc-5 text-black-shade3 mb-3px p-7p-label">Select
                                                        {{
                                                            this.ticketForm.get('ticket_trailer_type')?.value?  this.ticketForm.get('ticket_trailer_type')?.value :'Trailer'
                                                            }}
                                                    </div>

                                                    <ng-container *ngFor="let trailer of this.trailers_list">
                                                        <ng-container *ngIf="trailer?.trailer_type== this.ticketForm.get('ticket_trailer_type')?.value">
                                                            <div class="d-flex justify-content-between " *ngIf="trailer.is_available=='YES' && (checkAvailable('trailer',trailer,idx) || formItem.get('trailer_id')?.value==trailer.id)" >
                                                                <div [class]="formItem.get('trailer_id')?.value==trailer.id?'title-7 p-7p  text-black-shade3':'title-7 p-7p text-color-grey'" (click)="setTrailer(idx,trailer,formItem.get('ticket_id')?.value)">{{trailer.trailer_nickname}}</div>

                                                            </div>
                                                        </ng-container>
                                                    </ng-container>
                                                    <ng-container *ngFor="let trailer of this.trailers_list">
                                                        <ng-container *ngIf="trailer?.trailer_type== this.ticketForm.get('ticket_trailer_type')?.value">
                                                            <div class="d-flex justify-content-between " *ngIf="trailer.is_available=='NO'">
                                                                <div class='p-7p-disabled text-color-grey' >{{trailer.trailer_nickname}}-{{trailer?.current_job? trailer?.current_job?.ticket?.ticket_no:''}}</div>

                                                            </div>
                                                        </ng-container>
                                                    </ng-container>
                                                </div>
                                            </div>
                                        </ng-container>
                                        <label class="field text-field" *ngIf="!this.selected_trailer_type">
                                            <select  class="field__input " disabled="disabled" >
                                                <option value="">No Trailer</option>
                                                <option *ngFor="let trailer of this.trailers_list" [value]="trailer.id" >
                                                    {{trailer.trailer_nickname}}
                                                </option>
                                            </select>
                                           <input type="hidden" formControlName="trailer_id" value="">
                                            <span class="field__label-wrap">
                                                <span class="field__label">Select trailer</span>
                                            </span>
                                        </label>

                                    </div>

                                </div>
                            </ng-container>
                        </ng-container>
                    </ng-container>

                    <br>
                    <div align="center" class="d-flex justify-content-center">
                        <!-- data-dismiss="modal" data-toggle="modal" data-target="#ticket-dispatch-driver" -->
                        <button class="mybtn2 bg-medium-blue cp-8 text-white br-5 btn-border-none"  (click)="onDriverDispatch(); checkDriversError()"  type="button">Dispatch [{{this.driver_tickets.length}}] tickets</button>

                    </div>
                </form>

            </div>
        </div>
    </div>
</div>
